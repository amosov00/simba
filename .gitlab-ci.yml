image: docker:stable
services:
  - docker:dind

variables:
    DOCKER_DRIVER: overlay2
    SSH_OPTION: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"

before_script:
    - apk add --update --no-cache git openssh sshpass curl
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    - docker login -u "$ELASTOO_REGISTRY_USERNAME" -p "$ELASTOO_REGISTRY_SECRET" $ELASTOO_REGISTRY_URL

after_script:
    - docker logout $CI_REGISTRY
    - docker logout $ELASTOO_REGISTRY_URL

stages:
    - build
    - deploy

build-backend:
    stage: build
    variables:
        CONTAINER_NAME: 'backend'
        DOCKERFILE_PATH: './deployment/dockerfiles/Dockerfile.backend.$CI_COMMIT_REF_SLUG'
    script:
        - docker build --pull -t "$CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CONTAINER_NAME:$CI_COMMIT_REF_SLUG-latest" . -f $DOCKERFILE_PATH --no-cache
        - docker push "$CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CONTAINER_NAME:$CI_COMMIT_REF_SLUG-latest"
    only:
        - master
        - develop


build-frontend:
    stage: build
    variables:
        CONTAINER_NAME: 'frontend'
        DOCKERFILE_PATH: './deployment/dockerfiles/Dockerfile.frontend.$CI_COMMIT_REF_SLUG'
    script:
        - docker build --pull -t "$CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CONTAINER_NAME:$CI_COMMIT_REF_SLUG-latest" . -f $DOCKERFILE_PATH --no-cache
        - docker push "$CI_REGISTRY/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/$CONTAINER_NAME:$CI_COMMIT_REF_SLUG-latest"
    only:
        - master
        - develop

#deploy-develop:
#    stage: deploy
#    variables:
#        ENV: 'develop'
#    environment:
#        name: develop
#    script:
#        - echo "Starting deployment stage ..."
#        - sh ./deployment/scripts/deploy.sh
#    only:
#        - develop

#deploy-production:
#    stage: deploy
#    variables:
#        ENV: 'production'
#    environment:
#        name: production
#    script:
#        - echo "Starting deployment stage ..."
#        - sh ./deployment/scripts/deploy.sh
#    only:
#        - master